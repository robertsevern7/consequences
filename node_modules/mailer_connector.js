var Mailer = require('./mailer/lib/node_mailer');

module.exports.sendCompleteMessage = function(story) {
    console.log('Sending the complete story mail');
    sendMessage(story, true);
}

module.exports.sendUnfinishedMessage = function(story) {
    console.log('Sending the unfinished story mail');
    sendMessage(story, false);
}

function sendMessage(story, complete) {
    var storyContent = '';
    var contributors = [];
    for (var i = 0, len = story.sections.length; i < len; ++i) {
        var section = story.sections[i];
        contributors.push(section.contributorAddress);
        storyContent += story.sections[i].content + (i === (len - 1) ? '' : ' ');
    }
    
    var url = "http://thetalepipe.com/stories/" + story.id;

    for (var i = 0, len = contributors.length; i < len - 1; ++i) {
        var contributor = contributors[i];
        console.log('Mailing story ' + story.id + ' to ' + contributor)
        sendMail(contributor, story.title, storyContent, url, complete, story.sections.length);
    }
}

sendMail = function(address, title, content, url, complete, sectionsCount) {
    var subjectPrefix = complete ? 'Completed Tale' : 'Someone has contributed to your tale ';
    var template = complete ? 'CompleteStoryEmail.txt' : 'UnfinishedStoryEmail.txt';

    Mailer.send({
      host : "smtp.gmail.com",
      port : "465",
      ssl: true,
      domain : "thetalepipe.com",
      to : address,
      from : "TalePipe@thetalepipe.com",
      subject : subjectPrefix + ": " + title,
      template : "./node_modules/mailer_connector/" + template,
      data : {
        title: title,        
        story: '"' + content + '"',
        url: url,
        section: sectionsCount
      },
      authentication : "login",
      username : "TalePipe@thetalepipe.com",
      password : "k1nkyj0hn"
    },
    function(err, result){
      if(err){ console.log(err); }
    });
}