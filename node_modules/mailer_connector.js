var Mailer = require('./mailer/lib/node_mailer');

module.exports.sendCompleteMessage = function(story) {
    console.log('Sending the mail');
    
    var storyContent = '';
    var contributors = [];
    for (var i = 0, len = story.sections.length; i < len; ++i) {
        var section = story.sections[i];
        contributors.push(section.contributorAddress);
        storyContent += story.sections[i].content + (i === (len - 1) ? '' : ' ');
    }
    
    var url = "http://thetalepipe.com/stories/" + story.id
    for (var i = 0, len = contributors.length; i < len; ++i) {
        var contributor = contributors[i];
        sendMail(contributor, story.title, storyContent, url);
    }
}

sendMail = function(address, title, content, url) {
    Mailer.send({
      host : "smtp.gmail.com",
      port : "465",
      ssl: true,
      domain : "thetalepipe.com",
      to : address,
      from : "TalePipe@thetalepipe.com",
      subject : "Completed TalePipe: " + title,
      template : "./node_modules/mailer_connector/CompleteStoryEmail.txt",
      data : {
        title: title,        
        story: '"' + content + '"',
        url: url
      },
      authentication : "login",
      username : "TalePipe@thetalepipe.com",
      password : "k1nkyj0hn"
    },
    function(err, result){
      if(err){ console.log(err); }
    });
}